# 自动更新订单送达状态（草案）

## 目标
当物流查询接口返回“已送达”或同义状态时，系统自动将订单 `state` 更新为 `2`（已送达），并保留人工可见的状态更新时间记录。

## 建议流程
1. **触发方式**  
   - 后台定时任务（cron）定期扫描 `state = 1` 且存在 `logistics_no` 的订单。  
   - 任务调用 `track_api.php` 中的 `get_tracking_events` 获取物流轨迹。
2. **状态判定**  
   - 在解析返回数据时，针对不同物流提供商建立状态映射表。  
   - 识别“签收/妥投/已送达”等状态时，将订单更新为 `state = 2`。
3. **更新策略**  
   - 仅允许从 `state = 1` 升级到 `state = 2`，避免状态回退。  
   - 记录最后一次检查时间与原始响应（建议新增日志表或字段，便于排查）。
4. **异常处理**  
   - 物流接口不可用时仅记录失败，不变更订单状态。  
   - 若返回信息不完整，保留原状态并记录失败原因。

## 数据结构建议（可选）
- 新增 `orders.tracking_last_checked`（datetime）  
- 新增 `orders.tracking_raw`（text）或独立 `tracking_logs` 表存储每次响应  
- 如需分物流渠道，可在订单中增加 `send_way` 字段并传给 `get_tracking_events`

## 安全与性能注意事项
- 对外部接口添加速率限制，避免短时间大量请求。  
- 仅对 `state = 1` 的订单进行查询，减少无效调用。  
- 可根据物流单号前缀路由至对应 provider，提高解析准确度。
